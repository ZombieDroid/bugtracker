<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <meta charset="utf-8"/>
    <title>Tickets</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/classic/theme-neptune/resources/theme-neptune-all.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/ext-all-debug.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/extjs/6.2.0/classic/theme-neptune/theme-neptune.js"></script>
    <script type="text/javascript">
        var ticketStr = "[[${tickets}]]";
        Ext.onReady(function(){
            try{
                var tickets = JSON.parse(ticketStr.replace(/&quot;/g,'"'));

                var ticketStore = Ext.create('Ext.data.Store', {
                    fields : ['id', 'name', 'priority', 'description',
                        'reporter', 'status', 'project', 'spentTime', 'type'],
                    proxy : {
                        type : 'memory',
                        reader : {
                            type : 'json',
                            rootProperty : 'items'
                        }
                    }
                });

                var searchField = Ext.create('Ext.form.TextField', {
                    fieldLabel: 'Search'
                });

                var searchButton = Ext.create('Ext.button.Button', {
                    text: 'Search',
                    handler: function(){
                        Ext.Ajax.request({
                            url: "/api/ticket/searchTickets/" + searchField.text,
                            method: "GET",
                            success: function (form, action){
                                console.log(form.responseText);
                            },
                            failure: function(form, action){
                                alert(form.responseText);
                            }
                        });
                    }
                });

                //Ext.create()

                Ext.define('App.view.TicketPanel', {
                    extend: 'Ext.grid.Panel',
                    height: 600,
                    width: 1000,
                    title: 'Tickets',
                    store: ticketStore,

                    columns: [  {
                        text: 'Id',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'id'
                    },{
                        text: 'Name',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'name'
                    },{
                        text: 'Priority',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'priority'
                    },{
                        text: 'Description',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'description'
                    },{
                        text: 'Reporter',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'reporter'
                    },{
                        text: 'Status',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'status'
                    },{
                        text: 'Project',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'project'
                    },{
                        text: 'Spent Time',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'spentTime'
                    },{
                        text: 'Type',
                        width: 100,
                        sortable: false,
                        hideable: false,
                        dataIndex: 'type'
                    },],
                    viewConfig : {
                        listeners : {
                            itemdblclick : function(view, cell, cellIndex, record, row, rowIndex, e) {
                                window.location.assign("/api/ticket/"+cell.data.id);
                            }
                        }
                    }
                });

                var ticketPanel = Ext.create('App.view.TicketPanel', {
                    renderTo: Ext.getBody()
                });

                for(var i=0; i<tickets.length; i++){
                    var reporter = "";
                    var project = "";
                    var status = "";
                    var responseType = "";

                    if(tickets[i].reporterId != null){
                        Ext.Ajax.request({
                            url: "/api/ticket/getReporter/" + tickets[i].reporterId,
                            method: "GET",
                            success: function (form, action){
                                reporter = form.responseText;
                            },
                            failure: function(form, action){
                                alert(form.responseText);
                            }
                        });
                    }

                    if(tickets[i].projectId != null){
                        Ext.Ajax.request({
                            url: "/api/ticket/getProject/" + tickets[i].projectId,
                            method: "GET",
                            success: function (form, action){
                                project = form.responseText;
                            },
                            failure: function(form, action){
                                alert(form.responseText);
                            }
                        });
                    }

                    if(tickets[i].statusId != null){
                        Ext.Ajax.request({
                            url: "/api/ticket/getStatus/" + tickets[i].statusId,
                            method: "GET",
                            success: function (form, action){
                                status = form.responseText;
                            },
                            failure: function(form, action){
                                alert(form.responseText);
                            }
                        });
                    }

                    if(tickets[i].type != null){
                        Ext.Ajax.request({
                            url: "/api/ticket/getType/" + tickets[i].type,
                            method: "GET",
                            success: function (form, action){
                                console.log(form.responseText);
                                responseType = form.responseText;
                            },
                            failure: function(form, action){
                                alert(form.responseText);
                            }
                        });
                    }

                    ticketStore.add({id: tickets[i].id, name: tickets[i].name, priority: tickets[i].priority,
                        description: tickets[i].description, reporter: reporter, status: status,
                        project: project, spentTime: tickets[i].spentTime, type: responseType });
                }
            } catch(e){
                alert(e);
            }
        });
    </script>
</head>
<body>
    <div id="maindiv" style="height: 500px"/>
</body>
</html>